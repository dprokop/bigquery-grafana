/*! For license information please see module.js.LICENSE.txt */
define(["lodash","moment","app/core/app_events","app/plugins/sdk"],(function(t,e,r,a){return function(t){var e={};function r(a){if(e[a])return e[a].exports;var n=e[a]={i:a,l:!1,exports:{}};return t[a].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=t,r.c=e,r.d=function(t,e,a){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:a})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)r.d(a,n,function(e){return t[e]}.bind(null,n));return a},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="/",r(r.s=11)}([function(e,r){e.exports=t},function(t,e,r){"use strict";var a=r(2),n="object"==typeof self&&self&&self.Object===Object&&self,i=a.a||n||Function("return this")();e.a=i},function(t,e,r){"use strict";(function(t){var r="object"==typeof t&&t&&t.Object===Object&&t;e.a=r}).call(this,r(10))},function(t,e,r){"use strict";(function(t){var a=r(2),n="object"==typeof exports&&exports&&!exports.nodeType&&exports,i=n&&"object"==typeof t&&t&&!t.nodeType&&t,o=i&&i.exports===n&&a.a.process,s=function(){try{var t=i&&i.require&&i.require("util").types;return t||o&&o.binding&&o.binding("util")}catch(t){}}();e.a=s}).call(this,r(4)(t))},function(t,e){t.exports=function(t){if(!t.webpackPolyfill){var e=Object.create(t);e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),Object.defineProperty(e,"exports",{enumerable:!0}),e.webpackPolyfill=1}return e}},function(t,r){t.exports=e},function(t,e,r){"use strict";(function(t){var a=r(1),n=r(7),i="object"==typeof exports&&exports&&!exports.nodeType&&exports,o=i&&"object"==typeof t&&t&&!t.nodeType&&t,s=o&&o.exports===i?a.a.Buffer:void 0,u=(s?s.isBuffer:void 0)||n.a;e.a=u}).call(this,r(4)(t))},function(t,e,r){"use strict";e.a=function(){return!1}},function(t,e){t.exports=r},function(t,e){t.exports=a},function(t,e){var r;r=function(){return this}();try{r=r||new Function("return this")()}catch(t){"object"==typeof window&&(r=window)}t.exports=r},function(t,e,r){"use strict";r.r(e);var a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function n(t,e,r,a){return new(r||(r=Promise))((function(n,i){function o(t){try{u(a.next(t))}catch(t){i(t)}}function s(t){try{u(a.throw(t))}catch(t){i(t)}}function u(t){var e;t.done?n(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,s)}u((a=a.apply(t,e||[])).next())}))}function i(t,e){var r,a,n,i,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return i={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function s(i){return function(s){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;o;)try{if(r=1,a&&(n=2&i[0]?a.return:i[0]?a.throw||((n=a.return)&&n.call(a),0):a.next)&&!(n=n.call(a,i[1])).done)return n;switch(a=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,a=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(n=o.trys,(n=n.length>0&&n[n.length-1])||6!==i[0]&&2!==i[0])){o=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){o.label=i[1];break}if(6===i[0]&&o.label<n[1]){o.label=n[1],n=i;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(i);break}n[2]&&o.ops.pop(),o.trys.pop();continue}i=e.call(t,o)}catch(t){i=[6,t],a=0}finally{r=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,s])}}}function o(t){var e="function"==typeof Symbol&&Symbol.iterator,r=e&&t[e],a=0;if(r)return r.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&a>=t.length&&(t=void 0),{value:t&&t[a++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function s(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var a,n,i=r.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(a=i.next()).done;)o.push(a.value)}catch(t){n={error:t}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(n)throw n.error}}return o}var u=r(0),l=r.n(u),c=r(5),p=r.n(c),h=function(){function t(t,e,r){this.target=t,this.templateSrv=e,this.scopedVars=r,this.isWindow=!1,this.isAggregate=!1,this.groupBy="",this.tmpValue="",t.format=t.format||"time_series",t.orderByCol=t.orderByCol||"1",t.orderBySort=t.orderBySort||"1",t.location=t.location||void 0,t.timeColumn=t.timeColumn||"-- time --",t.timeColumnType=t.timeColumnType||"TIMESTAMP",t.metricColumn=t.metricColumn||"none",t.group=t.group||[],t.where=t.where||[{type:"macro",name:"$__timeFilter",params:[]}],t.select=t.select||[[{type:"column",params:["-- value --"]}]],"rawQuery"in this.target||(t.rawQuery="rawSql"in t),this.interpolateQueryStr=this.interpolateQueryStr.bind(this)}return t.$inject=["target","templateSrv","scopedVars"],t.quoteLiteral=function(t){return"'"+String(t).replace(/'/g,"''")+"'"},t.escapeLiteral=function(t){return String(t).replace(/'/g,"''")},t.quoteFiledName=function(t){for(var e=t.split("."),r="",a=0;a<e.length;a++)r=r+"`"+String(e[a])+"`",e.length>1&&a+1<e.length&&(r+=".");return r},t.formatDateToString=function(t,e,r){void 0===e&&(e=""),void 0===r&&(r=!1);var a=new Date(t),n=(a.getDate()<10?"0":"")+a.getDate(),i=(a.getMonth()+1<10?"0":"")+(a.getMonth()+1),o=a.getFullYear()+e+i+e+n;return!0===r&&(o+=" "+a.toTimeString().substr(0,8)),o},t._getInterval=function(t,e){var r=[],a=e?t.match(/(\$__timeGroupAlias\(([\w._]+,)).*?(?=\))/g):t.match(/(\$__timeGroup\(([\w_.]+,)).*?(?=\))/g);return a&&(r[0]=a[0].split(",")[1]?a[0].split(",")[1].trim():a[0].split(",")[1],r[1]=a[0].split(",")[2]?a[0].split(",")[2].trim():a[0].split(",")[2]),r},t.getUnixSecondsFromString=function(t){if(void 0===t)return 0;var e=dt._getShiftPeriod(t),r=e[0],a=e[1];switch(r){case"s":return 1*a;case"m":return 60*a;case"h":return 3600*a;case"d":return 86400*a;case"w":return 604800*a;case"M":return 2629743*a;case"y":return 31536e3*a}return 0},t.getTimeShift=function(t){var e;return(e=t.match(/(.*\$__timeShifting\().*?(?=\))/g))&&(e=e[0].substr(1+e[0].lastIndexOf("("))),e},t.replaceTimeShift=function(t){return t.replace(/(\$__timeShifting\().*?(?=\))./g,"")},t.convertToUtc=function(t){return new Date(t.getTime()+6e4*t.getTimezoneOffset())},t.prototype.getIntervalStr=function(e,r,a){"auto"===e&&(e=this._calcAutoInterval(a));var n,i=dt._getShiftPeriod(e)[0],o="TIMESTAMP_SECONDS(DIV(UNIX_SECONDS("+this._dateToTimestamp()+"), ",s=t.getUnixSecondsFromString(e);return n=void 0===r&&"0"===r?0:t.getUnixSecondsFromString(r),s=Math.max(s,n),"M"===i?o='TIMESTAMP(  (PARSE_DATE( "%Y-%m-%d",CONCAT( CAST((EXTRACT(YEAR FROM '+t.quoteFiledName(this.target.timeColumn)+")) AS STRING),'-',CAST((EXTRACT(MONTH FROM "+t.quoteFiledName(this.target.timeColumn)+")) AS STRING),'-','01'))))":o+=s+") * "+s+")",o+" AS time"},t.prototype.hasTimeGroup=function(){return l.a.find(this.target.group,(function(t){return"time"===t.type}))},t.prototype.hasMetricColumn=function(){return"none"!==this.target.metricColumn},t.prototype.interpolateQueryStr=function(e,r,a){return r.multi||r.includeAll?"string"==typeof e?t.quoteLiteral(e):l.a.map(e,t.quoteLiteral).join(","):t.escapeLiteral(e)},t.prototype.render=function(t){var e=this.target;return this.target.rawQuery||"table"in this.target?(e.rawQuery||(e.rawSql=this.buildQuery()),t?this.templateSrv.replace(e.rawSql,this.scopedVars,this.interpolateQueryStr):e.rawSql):""},t.prototype._buildTimeColumntimeGroup=function(t,e){var r,a="$__timeGroup";return r=e.params.length>1&&"none"!==e.params[1]?e.params.join(","):e.params[0],t&&(a+="Alias"),a+"("+this.target.timeColumn+","+r+")"},t.prototype.buildTimeColumn=function(e){void 0===e&&(e=!0);var r,a=this.hasTimeGroup();return a?r=this._buildTimeColumntimeGroup(e,a):(r=t.quoteFiledName(this.target.timeColumn),e&&(r+=" AS time")),r},t.prototype.buildMetricColumn=function(){return this.hasMetricColumn()?t.quoteFiledName(this.target.metricColumn)+" AS metric":""},t.prototype.buildValueColumns=function(){var t,e,r="";try{for(var a=o(this.target.select),n=a.next();!n.done;n=a.next()){var i=n.value,s=this.buildValueColumn(i);s.length>0&&(r+=",\n  "+s)}}catch(e){t={error:e}}finally{try{n&&!n.done&&(e=a.return)&&e.call(a)}finally{if(t)throw t.error}}return r},t.prototype.buildHllOuterQuery=function(){var t,e,r="time",a=1,n=0;this.hasMetricColumn()&&(r+=",\nmetric",a+=1);var i=0;try{for(var s=o(this.target.select),u=s.next();!u.done;u=s.next()){var c=u.value,p=l.a.find(c,(function(t){return"hll_count.merge"===t.type||"hll_count.extract"===t.type})),h=l.a.find(c,(function(t){return"alias"===t.type}));a+=1,p?("hll_count.merge"===p.type&&(n=a),r+=",\n"+p.type+"(respondents_hll)",h&&(r+=" AS "+h.params[0])):h?r+=",\n"+h.params[0]:(r+=",\nf"+i,i+=1)}}catch(e){t={error:e}}finally{try{u&&!u.done&&(e=s.return)&&e.call(s)}finally{if(t)throw t.error}}return{query:r,numOfColumns:a,hllInd:n}},t.prototype._buildAggregate=function(t,e){if(t){var r=t.params[0];switch(t.type){case"aggregate":e="first"===r||"last"===r?r+"("+e+","+this.target.timeColumn+")":r+"("+e+")";break;case"percentile":e=r+"("+t.params[1]+") WITHIN GROUP (ORDER BY "+e+")"}}return e},t.prototype.buildValueColumn=function(e){var r=l.a.find(e,(function(t){return"column"===t.type})),a=t.quoteFiledName(r.params[0]),n=l.a.find(e,(function(t){return"aggregate"===t.type||"percentile"===t.type})),i=l.a.find(e,(function(t){return"window"===t.type||"moving_window"===t.type})),o=l.a.find(e,(function(t){return"hll_count.merge"===t.type||"hll_count.extract"===t.type}));if(void 0!==o)return this.hll=o,"HLL_COUNT.INIT (CAST("+r.params[0]+" as NUMERIC)) as respondents_hll";this.isAggregate=void 0!==n;var s=l.a.find(e,(function(t){return"timeshift"===t.type}));if(a=this._buildAggregate(n,a),i){this.isWindow=!0;var u=[],c="PARTITION BY "+this.target.timeColumn;this.hasMetricColumn()?u.push(c+","+this.target.metricColumn):u.push(c),u.push("ORDER BY "+this.buildTimeColumn(!1));var p=u.join(" "),h=a,m=void 0,f=a;switch(i.type){case"window":switch(i.params[0]){case"delta":a=h+" - "+(m="lag("+h+") OVER ("+p+")");break;case"increase":a="(CASE WHEN "+h+" >= "+(m="lag("+h+") OVER ("+p+")")+" THEN "+h+" - "+m,a+=" WHEN "+m+" IS NULL THEN NULL ELSE "+h+" END)";break;case"rate":var d=this.target.timeColumn;n&&(d="min("+d+")"),a="(CASE WHEN "+h+" >= "+(m="lag("+h+") OVER ("+p+")")+" THEN "+h+" - "+m,a+=" WHEN "+m+" IS NULL THEN NULL ELSE "+h+" END)",a+="/(UNIX_SECONDS("+this._dateToTimestamp()+") -UNIX_SECONDS(  lag("+this._dateToTimestamp()+") OVER ("+p+")))";break;default:a=i.params[0]+"("+a+") OVER ("+p+")"}break;case"moving_window":a=f+" as tmp"+f+", "+(a=i.params[0]+"("+a+") OVER ("+p+" ROWS "+i.params[1]+" PRECEDING)")}this.tmpValue="tmp"+r.params[0],a=f+" as "+this.tmpValue+", "+a}var g=l.a.find(e,(function(t){return"alias"===t.type}));return g&&(a+=" AS "+g.params[0]),s&&(a+=" $__timeShifting("+s.params[0]+")"),a},t.prototype.buildWhereClause=function(){var e=this,r="",a=l.a.map(this.target.where,(function(t,r){switch(t.type){case"macro":return t.name+"("+e.target.timeColumn+")";case"expression":return t.params.join(" ")}}));if(this.target.partitioned){var n=this.target.partitionedField?this.target.partitionedField:"_PARTITIONTIME";if(this.target.timeColumn!==n){if(this.templateSrv.timeRange&&this.templateSrv.timeRange.from){var i=n+" >= '"+t.formatDateToString(this.templateSrv.timeRange.from._d,"-",!0)+"'";a.push(i)}if(this.templateSrv.timeRange&&this.templateSrv.timeRange.to){var o=n+" < '"+t.formatDateToString(this.templateSrv.timeRange.to._d,"-",!0)+"'";a.push(o)}}}if(this.target.sharded){var s="_TABLE_SUFFIX BETWEEN '"+(i=t.formatDateToString(this.templateSrv.timeRange.from._d))+"' AND '"+(o=t.formatDateToString(this.templateSrv.timeRange.to._d))+"' ";a.push(s)}return a.length>0&&(r="\nWHERE\n  "+a.join(" AND\n  ")),r},t.prototype.buildGroupClause=function(){for(var t,e,r="",a="",n=0;n<this.target.group.length;n++){var i=this.target.group[n];n>0&&(a+=", "),"time"===i.type?a+="1":a+=i.params[0]}r="\nGROUP BY ",a.length?(r+=a,this.groupBy=r,this.isWindow&&(r+=","+this.target.timeColumn+","+this.tmpValue,this.groupBy+=",2"),this.hasMetricColumn()&&(r+=",2",this.isWindow&&(this.groupBy+=",3"))):r="\nGROUP BY 1";var s=1;this.hasMetricColumn()&&(r+=",2",s+=1);try{for(var u=o(this.target.select),c=u.next();!c.done;c=u.next()){var p=c.value,h=l.a.find(p,(function(t){return"hll_count.merge"===t.type||"hll_count.extract"===t.type})),m=l.a.find(p,(function(t){return"aggregate"===t.type||"percentile"===t.type}));h||m?s++:r+=","+ ++s}}catch(e){t={error:e}}finally{try{c&&!c.done&&(e=u.return)&&e.call(u)}finally{if(t)throw t.error}}return this.isWindow&&(r=")"+r),r},t.prototype.buildQuery=function(){var t,e="",r="";e+="\nSELECT",e+="\n "+this.buildTimeColumn(),this.hasMetricColumn()&&(e+=",\n  "+this.buildMetricColumn()),e+=this.buildValueColumns();var a=" GROUP BY 1";if(void 0!==this.hll){var n=this.buildHllOuterQuery();r=n.query;for(var i=n.numOfColumns,o=n.hllInd,u=2;u<=i;u++)u!==o&&(a=a+","+u)}e+="\nFROM `"+this.target.project+"."+this.target.dataset+"."+this.target.table+"`",e+=this.buildWhereClause(),e+=this.buildGroupClause();var l="";if(this.isWindow){var c="*",p=void 0,h=this.tmpValue;this.tmpValue.includes(".")&&(p=(t=s(this.tmpValue.split("."),2))[0],h=t[1],c+=", "+p+".*"),e=(e="\nSELECT "+c+" EXCEPT ("+h+") From \n ("+e)+" "+this.groupBy}else l="\nORDER BY 1",this.hasMetricColumn()&&(l="1"===this.target.orderByCol?"\nORDER BY 1,2":"\nORDER BY 2,1"),"2"===this.target.orderBySort&&(l+=" DESC"),void 0===this.hll&&(e=e+" "+l);return void 0!==this.hll&&(e="\nSELECT \n"+r+" from \n("+e+") "+a+l),e="#standardSQL"+e},t.prototype.expend_macros=function(e){if(this.target.rawSql){var r=this.target.rawSql;return r=t.replaceTimeShift(r),r=this.replaceTimeFilters(r,e),r=this.replacetimeGroupAlias(r,!0,e),r=this.replacetimeGroupAlias(r,!1,e)}},t.prototype.replaceTimeFilters=function(e,r){var a=r.range.from,n=r.range.to;!0===this.target.convertToUTC&&(a=t.convertToUtc(r.range.from._d),n=t.convertToUtc(r.range.to._d));var i,o;if(o=this._getDateRangePart(a),i=this._getDateRangePart(n),"-- time --"===this.target.timeColumn){var s=/\$__timeFilter\(([\w_.]+)\)/g.exec(e);null!==s&&(this.target.timeColumn=s[1])}var u=t.quoteFiledName(this.target.timeColumn)+" BETWEEN "+o+" AND "+i,l=t.quoteFiledName(this.target.timeColumn)+" > "+o+" ",c=t.quoteFiledName(this.target.timeColumn)+" < "+i+" ";return e=(e=(e=(e=(e=e.replace(/\$__timeFilter\((.*?)\)/g,u)).replace(/\$__timeFrom\(([\w_.]+)\)/g,l)).replace(/\$__timeTo\(([\w_.]+)\)/g,c)).replace(/\$__millisTimeTo\(([\w_.]+)\)/g,i)).replace(/\$__millisTimeFrom\(([\w_.]+)\)/g,o)},t.prototype.replacetimeGroupAlias=function(e,r,a){var n=t._getInterval(e,r),i=n[0],o=n[1];if(!i)return e;var s=this.getIntervalStr(i,o,a);return r?e.replace(/\$__timeGroupAlias\(([\w_.]+,+[a-zA-Z0-9_ ]+.*\))/g,s):e.replace(/\$__timeGroup\(([\w_.]+,+[a-zA-Z0-9_ ]+.*\))/g,s)},t.prototype._dateToTimestamp=function(){return"DATE"===this.target.timeColumnType?"Timestamp("+t.quoteFiledName(this.target.timeColumn)+")":t.quoteFiledName(this.target.timeColumn)},t.prototype._calcAutoInterval=function(t){var e=(this.templateSrv.timeRange.to._d-this.templateSrv.timeRange.from._d)/1e3;return Math.ceil(e/t.maxDataPoints)+"s"},t.prototype._getDateRangePart=function(e){return"DATE"===this.target.timeColumnType?"'"+t.formatDateToString(e,"-")+"'":"DATETIME"===this.target.timeColumnType?"'"+t.formatDateToString(e,"-",!0)+"'":"TIMESTAMP_MILLIS ("+e.valueOf().toString()+")"},t}();var m=function(t,e){for(var r=-1,a=null==t?0:t.length;++r<a&&!1!==e(t[r],r,t););return t};var f=function(t){return function(e,r,a){for(var n=-1,i=Object(e),o=a(e),s=o.length;s--;){var u=o[t?s:++n];if(!1===r(i[u],u,i))break}return e}}();var d=function(t,e){for(var r=-1,a=Array(t);++r<t;)a[r]=e(r);return a},g=r(1).a.Symbol,v=Object.prototype,y=v.hasOwnProperty,S=v.toString,b=g?g.toStringTag:void 0;var w=function(t){var e=y.call(t,b),r=t[b];try{t[b]=void 0;var a=!0}catch(t){}var n=S.call(t);return a&&(e?t[b]=r:delete t[b]),n},T=Object.prototype.toString;var x=function(t){return T.call(t)},_=g?g.toStringTag:void 0;var P=function(t){return null==t?void 0===t?"[object Undefined]":"[object Null]":_&&_ in Object(t)?w(t):x(t)};var C=function(t){return null!=t&&"object"==typeof t};var j=function(t){return C(t)&&"[object Arguments]"==P(t)},I=Object.prototype,E=I.hasOwnProperty,q=I.propertyIsEnumerable,A=j(function(){return arguments}())?j:function(t){return C(t)&&E.call(t,"callee")&&!q.call(t,"callee")},D=Array.isArray,M=r(6),R=/^(?:0|[1-9]\d*)$/;var O=function(t,e){var r=typeof t;return!!(e=null==e?9007199254740991:e)&&("number"==r||"symbol"!=r&&R.test(t))&&t>-1&&t%1==0&&t<e};var F=function(t){return"number"==typeof t&&t>-1&&t%1==0&&t<=9007199254740991},N={};N["[object Float32Array]"]=N["[object Float64Array]"]=N["[object Int8Array]"]=N["[object Int16Array]"]=N["[object Int32Array]"]=N["[object Uint8Array]"]=N["[object Uint8ClampedArray]"]=N["[object Uint16Array]"]=N["[object Uint32Array]"]=!0,N["[object Arguments]"]=N["[object Array]"]=N["[object ArrayBuffer]"]=N["[object Boolean]"]=N["[object DataView]"]=N["[object Date]"]=N["[object Error]"]=N["[object Function]"]=N["[object Map]"]=N["[object Number]"]=N["[object Object]"]=N["[object RegExp]"]=N["[object Set]"]=N["[object String]"]=N["[object WeakMap]"]=!1;var k=function(t){return C(t)&&F(t.length)&&!!N[P(t)]};var L=function(t){return function(e){return t(e)}},Q=r(3),U=Q.a&&Q.a.isTypedArray,$=U?L(U):k,V=Object.prototype.hasOwnProperty;var B=function(t,e){var r=D(t),a=!r&&A(t),n=!r&&!a&&Object(M.a)(t),i=!r&&!a&&!n&&$(t),o=r||a||n||i,s=o?d(t.length,String):[],u=s.length;for(var l in t)!e&&!V.call(t,l)||o&&("length"==l||n&&("offset"==l||"parent"==l)||i&&("buffer"==l||"byteLength"==l||"byteOffset"==l)||O(l,u))||s.push(l);return s},G=Object.prototype;var W=function(t){var e=t&&t.constructor;return t===("function"==typeof e&&e.prototype||G)};var H=function(t,e){return function(r){return t(e(r))}}(Object.keys,Object),Y=Object.prototype.hasOwnProperty;var J=function(t){if(!W(t))return H(t);var e=[];for(var r in Object(t))Y.call(t,r)&&"constructor"!=r&&e.push(r);return e};var X=function(t){var e=typeof t;return null!=t&&("object"==e||"function"==e)};var K=function(t){if(!X(t))return!1;var e=P(t);return"[object Function]"==e||"[object GeneratorFunction]"==e||"[object AsyncFunction]"==e||"[object Proxy]"==e};var z=function(t){return null!=t&&F(t.length)&&!K(t)};var Z=function(t){return z(t)?B(t):J(t)};var tt=function(t,e){return function(r,a){if(null==r)return r;if(!z(r))return t(r,a);for(var n=r.length,i=e?n:-1,o=Object(r);(e?i--:++i<n)&&!1!==a(o[i],i,o););return r}}((function(t,e){return t&&f(t,e,Z)}));var et=function(t){return t};var rt=function(t){return"function"==typeof t?t:et};var at,nt=function(t,e){return(D(t)?m:tt)(t,rt(e))},it=function(){function t(t){this.$q=t}return t.parseProjects=function(e){return t.parseData(e,"id","id")},t.parseDatasets=function(e){return t.parseData(e,"datasetReference.datasetId","datasetReference.datasetId")},t.parseTableFields=function(e,r){var a,n,i,s,u=[];if(!e||0===e.length)return u;e=t._handleRecordFields(e,[]);try{for(var l=o(e),c=l.next();!c.done;c=l.next()){var p=c.value;if(r.length>0)try{for(var h=(i=void 0,o(r)),m=h.next();!m.done;m=h.next()){m.value===p.type&&u.push({text:p.name,value:p.type})}}catch(t){i={error:t}}finally{try{m&&!m.done&&(s=h.return)&&s.call(h)}finally{if(i)throw i.error}}else u.push({text:p.name,value:p.type})}}catch(t){a={error:t}}finally{try{c&&!c.done&&(n=l.return)&&n.call(l)}finally{if(a)throw a.error}}return u},t.parseDataQuery=function(e,r){if(!e.rows)return[{data:[]}];var a=null;return"time_series"===r&&(a=t._toTimeSeries(e)),"table"===r&&(a=t._toTable(e)),"var"===r&&(a=t._toVar(e)),null===a&&(a=[]),a},t._convertValues=function(t,e){return["INT64","NUMERIC","FLOAT64","FLOAT","INT","INTEGER"].includes(e)?Number(t):["TIMESTAMP"].includes(e)?new Date(1e3*Number(t)).toString():t},t.parseData=function(e,r,a){var n,i,s=[];if(!e||0===e.length)return s;var u,l,c=r.split("."),p=a.split(".");try{for(var h=o(e),m=h.next();!m.done;m=h.next()){var f=m.value;l=(f=t.manipulateItem(f))[c[0]],u=f[p[0]];for(var d=1;d<c.length;d++)l=l[c[d]];for(d=1;d<p.length;d++)u=u[p[d]];s.push({text:l,value:u})}}catch(t){n={error:t}}finally{try{m&&!m.done&&(i=h.return)&&i.call(h)}finally{if(n)throw n.error}}return s},t.manipulateItem=function(t){return"bigquery#table"===t.kind&&t.timePartitioning&&(t.tableReference.tableId=t.tableReference.tableId+"__partitioned",t.timePartitioning.field&&(t.tableReference.tableId+="__"+t.timePartitioning.field)),t},t._handleRecordFields=function(e,r){var a,n,i,s,u,l;try{for(var c=o(e),p=c.next();!p.done;p=c.next()){var h=p.value;if("RECORD"===h.type)try{for(var m=(i=void 0,o(h.fields)),f=m.next();!f.done;f=m.next()){var d=f.value;if("RECORD"!==d.type)r.push({name:h.name+"."+d.name,type:d.type});else{try{for(var g=(u=void 0,o(d.fields)),v=g.next();!v.done;v=g.next()){var y=v.value;y.name=h.name+"."+d.name+"."+y.name}}catch(t){u={error:t}}finally{try{v&&!v.done&&(l=g.return)&&l.call(g)}finally{if(u)throw u.error}}r=t._handleRecordFields(d.fields,r)}}}catch(t){i={error:t}}finally{try{f&&!f.done&&(s=m.return)&&s.call(m)}finally{if(i)throw i.error}}else r.push({name:h.name,type:h.type})}}catch(t){a={error:t}}finally{try{p&&!p.done&&(n=c.return)&&n.call(c)}finally{if(a)throw a.error}}return r},t._toTimeSeries=function(e){for(var r=-1,a=-1,n=[],i=0;i<e.schema.fields.length;i++)-1===r&&["DATE","TIMESTAMP","DATETIME"].includes(e.schema.fields[i].type)&&(r=i),-1===a&&"metric"===e.schema.fields[i].name&&(a=i),["INT64","NUMERIC","FLOAT64","FLOAT","INT","INTEGER"].includes(e.schema.fields[i].type)&&n.push(i);if(-1===r)throw new Error("No datetime column found in the result. The Time Series format requires a time column.");return t._buildDataPoints(e,r,a,n)},t._buildDataPoints=function(e,r,a,n){var i,s,u,l=[],c="",p="";try{for(var h=o(e.rows),m=h.next();!m.done;m=h.next()){var f=m.value;if(f)for(u=0;u<n.length;u++){var d=1e3*Number(f.f[r].v),g=e.schema.fields[n[u]].name;c=a>-1?f.f[a].v.concat(" ",g):g,p=a>-1?f.f[a].v:g,a>-1&&1===n.length&&(c=p);var v=t.findOrCreateBucket(l,c,p),y=null===f.f[n[u]].v?null:Number(f.f[n[u]].v);v.datapoints.push([y,d])}}}catch(t){i={error:t}}finally{try{m&&!m.done&&(s=h.return)&&s.call(h)}finally{if(i)throw i.error}}return l},t.findOrCreateBucket=function(t,e,r){var a=l.a.find(t,["target",e]);return a||(a={target:e,datapoints:[],refId:r,query:""},t.push(a)),a},t._toTable=function(e){var r,a,n=[];try{for(var i=o(e.schema.fields),s=i.next();!s.done;s=i.next()){var u=s.value;n.push({text:u.name,type:u.type})}}catch(t){r={error:t}}finally{try{s&&!s.done&&(a=i.return)&&a.call(i)}finally{if(r)throw r.error}}var l=[];return nt(e.rows,(function(e){var r=[];nt(e,(function(e){for(var a=0;a<e.length;a++){var i=e[a].v?t._convertValues(e[a].v,n[a].type):"";r.push(i)}})),l.push(r)})),{columns:n,rows:l,type:"table"}},t._toVar=function(t){var e,r,a=[];try{for(var n=o(t.rows),i=n.next();!i.done;i=n.next()){var s=i.value;a.push(s.f[0].v)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(e)throw e.error}}return l.a.map(a,(function(t){return{text:t}}))},t.prototype.parseTabels=function(e){return this._handelWildCardTables(t.parseData(e,"tableReference.tableId","tableReference.tableId"))},t.prototype.transformAnnotationResponse=function(t,e){for(var r,a,n=e.data,i=-1,s=-1,u=-1,l=0;l<e.data.schema.fields.length;l++)"time"===e.data.schema.fields[l].name?i=l:"text"===e.data.schema.fields[l].name?s=l:"tags"===e.data.schema.fields[l].name&&(u=l);if(-1===i)return this.$q.reject({message:"Missing mandatory time column in annotation query."});var c=[];if(n.rows&&n.rows.length)try{for(var p=o(n.rows),h=p.next();!h.done;h=p.next()){var m=h.value;c.push({annotation:t.annotation,tags:m.f[u].v?m.f[u].v.trim().split(/\s*,\s*/):[],text:m.f[s].v?m.f[s].v.toString():"",time:1e3*Number(Math.floor(Number(m.f[i].v)))})}}catch(t){r={error:t}}finally{try{h&&!h.done&&(a=p.return)&&a.call(p)}finally{if(r)throw r.error}}return c},t.prototype._handelWildCardTables=function(t){var e,r,a=new Map,n=[];try{for(var i=o(t),s=i.next();!s.done;s=i.next()){var u=s.value,l=u.text.indexOf("__partitioned");l>-1&&(u.text=u.text.substring(0,l)),u.value.match(/_(?:(?:20\d{2})(?:(?:(?:0[13578]|1[02])31)|(?:(?:0[1,3-9]|1[0-2])(?:29|30)))|(?:(?:20(?:0[48]|[2468][048]|[13579][26]))0229)|(?:20\d{2})(?:(?:0?[1-9])|(?:1[0-2]))(?:0?[1-9]|1\d|2[0-8]))(?!\d)$/g)?a.set(u.text.substring(0,u.text.length-8)+"YYYYMMDD",u.text.substring(0,u.text.length-8)+"YYYYMMDD"):a=a.set(u.value,u.text)}}catch(t){e={error:t}}finally{try{s&&!s.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}return a.forEach((function(t,e){n=n.concat({text:t,value:e})})),n},t}(),ot=function(){function t(){}return t.getProjectDatasetTableFromSql=function(e){try{var r=t.getFullJobId(e),a=t.getDatasetId(r);return[t.getProjectIdFromFullId(r),a,t.getTableId(r)]}catch(t){return[]}},t.getFullJobId=function(t){var e="";if(t){var r=t.match(/from\s{0,}[\S]{1,}|from\s[\S]{2,}/gi);r&&Array.isArray(r)&&r.forEach((function(t){(e=t.replace(/from|\n|;/gi," ").trim()).match(/`|\[|\.|:/)&&(e=e.replace(/`|\[|\]/g,""))}))}return e},t.getDatasetId=function(e){var r="";if(t.isStandardSql(e).isStandard){var a=e.split(".");r=(n=a.length)>2?a[n-2]:a[n-1],e.toLowerCase().includes(".information_schema")&&(4===n&&(r=a[1]),3===n&&(r=a[0]))}else{var n,i=e.split(":");r=i[(n=i.length)-1].split(".")[0]}return r=r.replace(/`|\[|\]/g,"")},t.isStandardSql=function(e){var r,a,n,i="",o=e.split(/[:.]|:\./g);if(o.length>3){var s=t.try2findProjectId(e,i);e=s.idString,i=s.projectId}if(e.match(/:/g))(u=e.match(/([\[]([^[]|[\[][\]])*[\]])|[:.]/g))&&u[0]?(a=":"===u[0]&&"."===u[1]?e:i+u[0].substring(1,e.length-1),r=!1):t.errorMessage("First Regex",e,"");else if(e.match(/\./g)&&2===e.match(/\./g).length){var u;(u=e.match(/(`([^`]|``)*`)/g))&&u[0]?(a=i+u[0].substring(1,e.length-1),r=!0):!u&&e?(a=i+e,r=!0):t.errorMessage("Second Regex",e,"")}else 2===o.length&&(a="","["===e[0]&&"]"===e[e.length-1]?r=!1:"`"===e[0]&&"`"===e[e.length-1]&&(r=!0),n=e.replace(/`|\[|\]/g,""));return{isStandard:r,fullId:a,partialId:n}},t.try2findProjectId=function(t,e){for(var r=0,a=t.length;a>0;a--){var n=t[a-1];":"!==n&&"."!==n||2===++r&&(e="`"===t[0]?t.substring(1,a-1):t.substring(0,a-1),t="]"===(t="`"===(t=t.substring(a-1,t.length))[t.length-1]?"`"+t:t)[t.length-1]?"["+t:t)}return{idString:t,projectId:e}},t.errorMessage=function(t,e,r){throw t+" "+(r||"Id is not valid and not related to either legacy nor standard. id:")+" "+e},t.getProjectIdFromFullId=function(t){if(void 0===t||0===t.length)return"";var e,r=t.split(/[.:]/g);if(r.length>3)for(var a=0,n=t.length;n>0;n--){var i=t[n-1];"."!==i&&":"!==i||2===++a&&(e=t.substring(0,n-1).replace(/[[`]/g,""),t.toLowerCase().includes(".information_schema")&&(e=r[0]))}else t.toLowerCase().includes(".information_schema")||(e=r[0].replace(/[[`]/g,""));return e},t.getTableId=function(e){var r=t.isStandardSql(e),a=r.fullId;if(r.fullId&&r.fullId.toString().indexOf(".")>-1){var n=r.fullId.split(".");a=r.fullId.toLowerCase().includes(".information_schema")?n[n.length-2]+"."+n[n.length-1]:n[n.length-1]}else if(r.partialId&&r.partialId.indexOf(".")>-1){a=(n=r.partialId.split("."))[n.length-1]}return a},t}(),st=new Uint8Array(16);function ut(){if(!at&&!(at="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return at(st)}var lt=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;for(var ct=function(t){return"string"==typeof t&&lt.test(t)},pt=[],ht=0;ht<256;++ht)pt.push((ht+256).toString(16).substr(1));var mt=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=(pt[t[e+0]]+pt[t[e+1]]+pt[t[e+2]]+pt[t[e+3]]+"-"+pt[t[e+4]]+pt[t[e+5]]+"-"+pt[t[e+6]]+pt[t[e+7]]+"-"+pt[t[e+8]]+pt[t[e+9]]+"-"+pt[t[e+10]]+pt[t[e+11]]+pt[t[e+12]]+pt[t[e+13]]+pt[t[e+14]]+pt[t[e+15]]).toLowerCase();if(!ct(r))throw TypeError("Stringified UUID is invalid");return r};var ft=function(t,e,r){var a=(t=t||{}).random||(t.rng||ut)();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,e){r=r||0;for(var n=0;n<16;++n)e[r+n]=a[n];return e}return mt(a)};var dt=function(){function t(t,e,r,a){var o=this;this.backendSrv=e,this.$q=r,this.templateSrv=a,this.interpolateVariable=function(t,e){return"string"==typeof t?e.multi||e.includeAll?h.quoteLiteral(t):t:"number"==typeof t?t:l.a.map(t,(function(t){return h.quoteLiteral(t)})).join(",")},this.id=t.id,this.jsonData=t.jsonData,this.responseParser=new it(this.$q),this.queryModel=new h({}),this.baseUrl="/bigquery/",this.url=t.url,this.authenticationType=t.jsonData.authenticationType||"jwt",n(o,void 0,void 0,(function(){var e,r;return i(this,(function(a){switch(a.label){case 0:return e=this,(r=t.jsonData.defaultProject)?[3,2]:[4,this.getDefaultProject()];case 1:r=a.sent(),a.label=2;case 2:return e.projectName=r,[2]}}))})),this.runInProject=this.jsonData.flatRateProject&&this.jsonData.flatRateProject.length?this.jsonData.flatRateProject:this.projectName,this.processingLocation=this.jsonData.processingLocation&&this.jsonData.processingLocation.length?this.jsonData.processingLocation:void 0,this.queryPriority=this.jsonData.queryPriority}return t.$inject=["instanceSettings","backendSrv","$q","templateSrv"],t.formatBigqueryError=function(t){var e="BigQuery: ",r="",a="";return void 0!==t&&(e+=t.message?t.message:"Cannot connect to BigQuery API",r=t.code,a=t.errors[0].reason+": "+t.message),{data:{message:a},status:r,statusText:e}},t._getShiftPeriod=function(t){var e=t.match(/\d+/)[0];return"min"===(t=t.substr(e.length,t.length)).trim()&&(t="m"),[t,e]},t._extractFromClause=function(t){return ot.getProjectDatasetTableFromSql(t)},t._FindTimeField=function(t,e){for(var r,a,n,i=t.search(/select/i),s=t.search(/from/i),u=t.substring(i+6,s).split(","),l=0;l<u.length;l++){var c=u[l].search(/ AS /i);-1===c&&(c=u[l].length),n=(n=(n=(n=(n=(n=(n=(n=u[l].substring(0,c).trim().replace("`","").replace("`","")).replace(/\$__timeGroupAlias\(/g,"")).replace(/\$__timeGroup\(/g,"")).replace(/\$__timeFilter\(/g,"")).replace(/\$__timeFrom\(/g,"")).replace(/\$__timeTo\(/g,"")).replace(/\$__millisTimeTo\(/g,"")).replace(/\$__millisTimeFrom\(/g,"");try{for(var p=(r=void 0,o(e)),h=p.next();!h.done;h=p.next()){var m=h.value;if(m.text===n)return m}}catch(t){r={error:t}}finally{try{h&&!h.done&&(a=p.return)&&a.call(p)}finally{if(r)throw r.error}}}return null},t._handleError=function(e){if(!0===e.cancelled)return[];var r=e;throw void 0!==e.data&&(r=e.data.error),t.formatBigqueryError(r)},t._createTimeShiftQuery=function(t){var e=h.getTimeShift(t.rawSql);if(!e)return e;var r=t.constructor();for(var a in t)t.hasOwnProperty(a)&&(r[a]=t[a]);return r.rawSql=h.replaceTimeShift(r.rawSql),r.format+="#"+e,r.refId+="_shifted_"+e,r},t._setupTimeShiftQuery=function(e,r){var a=e.format.indexOf("#"),n=r.constructor();for(var i in r)r.hasOwnProperty(i)&&(n[i]=r[i]);if(-1===a)return n;var o=e.format.substr(a+1,e.format.len),s=t._getShiftPeriod(o);if(o=s[0],!["s","min","h","d","w","m","w","y","M"].includes(o))return n;e.format=e.format.substr(0,a),o=s[0];var u=s[1];return"min"===o&&(o="m"),n.range.from=r.range.from.subtract(parseInt(u,10),o),n.range.to=r.range.to.subtract(parseInt(u,10),o),n},t._updatePartition=function(t,e){if(t.indexOf("AND _PARTITIONTIME >= ")<1)return t;if(t.indexOf("AND _PARTITIONTIME <")<1)return t;var r=t.substr(t.indexOf("AND _PARTITIONTIME >= ")+22,21),a="'"+h.formatDateToString(e.range.from._d,"-",!0)+"'",n=(t=t.replace(r,a)).substr(t.indexOf("AND _PARTITIONTIME < ")+21,21),i="'"+h.formatDateToString(e.range.to._d,"-",!0)+"'";return t=t.replace(n,i)+"\n "},t._updateTableSuffix=function(t,e){var r=t.indexOf("AND  _TABLE_SUFFIX BETWEEN ");if(r<1)return t;var a=t.substr(r+28,8),n=h.formatDateToString(e.range.from._d),i=(t=t.replace(a,n)).substr(r+43,8),o=h.formatDateToString(e.range.to._d);return t=t.replace(i,o)+"\n "},t.prototype.query=function(e){return n(this,void 0,void 0,(function(){var r,a,n,u=this;return i(this,(function(i){return 0===(r=l.a.filter(e.targets,(function(t){return!0!==t.hide})).map((function(t){var r=new h(t,u.templateSrv,e.scopedVars);return u.queryModel=r,{queryPriority:u.queryPriority,datasourceId:u.id,format:t.format,intervalMs:e.intervalMs,maxDataPoints:e.maxDataPoints,metricColumn:t.metricColumn,partitioned:t.partitioned,partitionedField:t.partitionedField,rawSql:r.render(u.interpolateVariable),refId:t.refId,sharded:t.sharded,table:t.table,timeColumn:t.timeColumn,timeColumnType:t.timeColumnType}}))).length?[2,this.$q.when({data:[]})]:(l.a.map(r,(function(e){var a=t._createTimeShiftQuery(e);a&&r.push(a)})),n=l.a.map(r,(function(r){var n=u.queryModel.target.rawSql;if(!1===u.queryModel.target.rawQuery){u.queryModel.target.metricColumn=r.metricColumn,u.queryModel.target.partitioned=r.partitioned,u.queryModel.target.partitionedField=r.partitionedField,u.queryModel.target.rawSql=r.rawSql,u.queryModel.target.sharded=r.sharded,u.queryModel.target.table=r.table,u.queryModel.target.timeColumn=r.timeColumn,u.queryModel.target.timeColumnType=r.timeColumnType,a=t._setupTimeShiftQuery(r,e);var i=u.setUpQ(a,e,r);return u.queryModel.target.rawSql=i,u.doQuery(i,e.panelId+r.refId,r.queryPriority).then((function(t){return it.parseDataQuery(t,r.format)}))}var o=u.templateSrv.replace(n,e.scopedVars,u.interpolateVariable),l=s(t._extractFromClause(o),3),c=l[0],p=l[1],h=l[2];u.getDateFields(c,p,h).then((function(e){var r=t._FindTimeField(n,e);u.queryModel.target.timeColumn=r.text,u.queryModel.target.timeColumnType=r.value,u.queryModel.target.table=h})).catch((function(t){})),u.queryModel.target.rawSql=r.rawSql,a=t._setupTimeShiftQuery(r,e);i=u.setUpQ(a,e,r);return u.doQuery(i,e.panelId+r.refId,r.queryPriority).then((function(t){return it.parseDataQuery(t,r.format)}))})),[2,this.$q.all(n).then((function(e){var r,a,n,i,s,u,l=[];if(e)try{for(var c=o(e),h=c.next();!h.done;h=c.next()){var m=h.value;if(m.type&&"table"===m.type)l.push(m);else try{for(var f=(n=void 0,o(m)),d=f.next();!d.done;d=f.next()){var g=d.value;l.push(g)}}catch(t){n={error:t}}finally{try{d&&!d.done&&(i=f.return)&&i.call(f)}finally{if(n)throw n.error}}}}catch(t){r={error:t}}finally{try{h&&!h.done&&(a=c.return)&&a.call(c)}finally{if(r)throw r.error}}try{for(var v=o(l),y=v.next();!y.done;y=v.next()){var S=y.value;if(void 0!==S.target&&S.target.search("_shifted")>-1)for(var b=t._getShiftPeriod(S.target.substring(S.target.lastIndexOf("_")+1,S.target.length)),w=b[0],T=b[1],x=0;x<S.datapoints.length;x++)S.datapoints[x][1]=p()(S.datapoints[x][1]).subtract(T,w).valueOf()}}catch(t){s={error:t}}finally{try{y&&!y.done&&(u=v.return)&&u.call(v)}finally{if(s)throw s.error}}return{data:l}}))])}))}))},t.prototype.metricFindQuery=function(t,e){var r="tempvar";e&&e.variable&&e.variable.name&&(r=e.variable.name);var a={datasourceId:this.id,format:"table",rawSql:this.templateSrv.replace(t,{},this.interpolateVariable),refId:r};return this.doQuery(a.rawSql,r,t.queryPriority).then((function(t){return it.parseDataQuery(t,"var")}))},t.prototype.testDatasource=function(){return n(this,void 0,void 0,(function(){var t,e,r,a,n,o,s,u;return i(this,(function(i){switch(i.label){case 0:if(t="success",e="Successfully queried the BigQuery API.",r="Cannot connect to BigQuery API",this.projectName)return[3,4];i.label=1;case 1:return i.trys.push([1,3,,4]),[4,this.getDefaultProject()];case 2:return i.sent(),[3,4];case 3:return a=i.sent(),e=a.statusText?a.statusText:r,[3,4];case 4:return i.trys.push([4,6,,7]),o="v2/projects/"+this.projectName+"/datasets",[4,this.doRequest(""+this.baseUrl+o)];case 5:return 200!==(s=i.sent()).status&&(t="error",e=s.statusText?s.statusText:r),[3,7];case 6:return n=i.sent(),e=n.statusText?n.statusText:r,[3,7];case 7:return i.trys.push([7,9,,10]),o="v2/projects/"+this.projectName+"/jobs/no-such-jobs",[4,this.doRequest(""+this.baseUrl+o)];case 8:return 200!==(s=i.sent()).status&&(t="error",e=s.statusText?s.statusText:r),[3,10];case 9:return 404!==(u=i.sent()).status&&(e=u.statusText?u.statusText:r),[3,10];case 10:return[2,{message:e,status:t}]}}))}))},t.prototype.getProjects=function(){return n(this,void 0,Promise,(function(){var t;return i(this,(function(e){switch(e.label){case 0:return"v2/projects",[4,this.paginatedResults("v2/projects","projects")];case 1:return t=e.sent(),[2,it.parseProjects(t)]}}))}))},t.prototype.getDatasets=function(t){return n(this,void 0,Promise,(function(){var e,r;return i(this,(function(a){switch(a.label){case 0:return e="v2/projects/"+t+"/datasets",[4,this.paginatedResults(e,"datasets")];case 1:return r=a.sent(),[2,it.parseDatasets(r)]}}))}))},t.prototype.getTables=function(t,e){return n(this,void 0,Promise,(function(){var r,a;return i(this,(function(n){switch(n.label){case 0:return r="v2/projects/"+t+"/datasets/"+e+"/tables",[4,this.paginatedResults(r,"tables")];case 1:return a=n.sent(),[2,new it(this.$q).parseTabels(a)]}}))}))},t.prototype.getTableFields=function(t,e,r,a){return n(this,void 0,Promise,(function(){var n,o;return i(this,(function(i){switch(i.label){case 0:return n="v2/projects/"+t+"/datasets/"+e+"/tables/"+r,[4,this.paginatedResults(n,"schema.fields")];case 1:return o=i.sent(),[2,it.parseTableFields(o,a)]}}))}))},t.prototype.getDateFields=function(t,e,r){return n(this,void 0,void 0,(function(){return i(this,(function(a){return[2,this.getTableFields(t,e,r,["DATE","TIMESTAMP","DATETIME"])]}))}))},t.prototype.getDefaultProject=function(){return n(this,void 0,void 0,(function(){var t;return i(this,(function(e){switch(e.label){case 0:return e.trys.push([0,4,,5]),"gce"!==this.authenticationType&&this.projectName?[3,2]:[4,this.getProjects()];case 1:return t=e.sent(),this.projectName=t[0].value,this.runInProject||(this.runInProject=this.projectName),[2,t[0].value];case 2:return[2,this.projectName];case 3:return[3,5];case 4:return e.sent(),[2,this.projectName=""];case 5:return[2]}}))}))},t.prototype.annotationQuery=function(t){var e=this,r="v2/projects/"+this.runInProject+"/queries",a=this.url+""+this.baseUrl+r;if(!t.annotation.rawQuery)return this.$q.reject({message:"Query missing in annotation definition"});var n=this.templateSrv.replace(t.annotation.rawQuery,t.scopedVars,this.interpolateVariable),i={datasourceId:this.id,format:"table",rawSql:n,refId:t.annotation.name};return this.queryModel.target.rawSql=i.rawSql,i.rawSql=this.queryModel.expend_macros(t),this.backendSrv.datasourceRequest({data:{priority:this.queryPriority,from:t.range.from.valueOf().toString(),query:i.rawSql,to:t.range.to.valueOf().toString(),useLegacySql:!1,useQueryCache:!0},method:"POST",requestId:t.annotation.name,url:a}).then((function(r){return e.responseParser.transformAnnotationResponse(t,r)}))},t.prototype.setUpQ=function(e,r,a){var n=this.queryModel.expend_macros(e);if(n&&(n=this.setUpPartition(n,a.partitioned,a.partitionedField,e),n=t._updatePartition(n,e),n=t._updateTableSuffix(n,e),a.refId.search("_shifted")>-1&&(n=this._updateAlias(n,e,a.refId)),null==n.match(/[^]+(\bLIMIT\b)/gi))){var i=" LIMIT "+r.maxDataPoints;null!==n.match(/\$__limitPosition/g)?n=n.replace(/\$__limitPosition/g,i):n+=i}return n},t.prototype.setUpPartition=function(t,e,r,a){if(r=r||"_PARTITIONTIME",e&&!t.match(new RegExp(r,"i"))){var n=h.convertToUtc(a.range.from._d),i=h.convertToUtc(a.range.to._d),o="where "+(r+" >= '"+h.formatDateToString(n,"-",!0)+"'")+" AND "+(r+" < '"+h.formatDateToString(i,"-",!0)+"'")+" AND ";if(t.match(/where/i))t=t.replace(/where/i,o);else{var s=/from ('|`|"|){1}(.*?)('|`|"|){1} as ('|`|"|)(\S*)('|`|"|){1}|from ('|`|"|){1}(\S*)('|`|"|){1}/i,u=t.match(s);t=t.replace(s,u+" "+u)}}return t},t.prototype.doRequest=function(e,r,a){return void 0===r&&(r="requestId"),void 0===a&&(a=3),n(this,void 0,void 0,(function(){var n=this;return i(this,(function(i){return[2,this.backendSrv.datasourceRequest({method:"GET",requestId:ft(),url:this.url+e}).then((function(i){if(200!==i.status){if(i.status>=500&&a>0)return n.doRequest(e,r,a-1);throw t.formatBigqueryError(i.data.error)}return i})).catch((function(i){return a>0?n.doRequest(e,r,a-1):!0===i.cancelled?[]:t._handleError(i)}))]}))}))},t.prototype.doQueryRequest=function(e,r,a,o){return void 0===o&&(o=3),n(this,void 0,void 0,(function(){var n,s,u,l,c,p=this;return i(this,(function(i){return n=this.queryModel.target.location||this.processingLocation||"US",u="queries",s={priority:a,location:n,query:e,useLegacySql:!1,useQueryCache:!0},"BATCH"===a.toUpperCase()&&(u="jobs",s={configuration:{query:{query:e,priority:a}}}),l="v2/projects/"+this.runInProject+"/"+u,c=this.url+""+this.baseUrl+l,[2,this.backendSrv.datasourceRequest({data:s,method:"POST",requestId:r,url:c}).then((function(n){if(200!==n.status){if(n.status>=500&&o>0)return p.doQueryRequest(e,r,a,o-1);throw t.formatBigqueryError(n.data.error)}return n})).catch((function(n){return o>0?p.doQueryRequest(e,r,a,o-1):!0===n.cancelled?[]:t._handleError(n)}))]}))}))},t.prototype._waitForJobComplete=function(t,e,r){return n(this,void 0,void 0,(function(){var a,n,o;return i(this,(function(i){switch(i.label){case 0:a=100,n=this.queryModel.target.location||this.processingLocation||"US",o="v2/projects/"+this.runInProject+"/queries/"+r+"?location="+n,i.label=1;case 1:return t.data.jobComplete?[3,4]:[4,(s=a,new Promise((function(t){setTimeout(t,s)})))];case 2:return i.sent(),a*=2,[4,this.doRequest(""+this.baseUrl+o,e)];case 3:return t=i.sent(),[3,1];case 4:return[2,t]}var s}))}))},t.prototype._getQueryResults=function(t,e,r,a){return n(this,void 0,void 0,(function(){var n,o;return i(this,(function(i){switch(i.label){case 0:return t.data.pageToken?(n=this.queryModel.target.location||this.processingLocation||"US",o="v2/projects/"+this.runInProject+"/queries/"+a+"?pageToken="+t.data.pageToken+"&location="+n,[4,this.doRequest(""+this.baseUrl+o,r)]):[3,2];case 1:return 0===(t=i.sent()).length?[2,e]:(e=e.concat(t.data.rows),[3,0]);case 2:return[2,e]}}))}))},t.prototype.doQuery=function(t,e,r){return void 0===r&&(r="INTERACTIVE"),n(this,void 0,void 0,(function(){var a,n,o,s,u;return i(this,(function(i){switch(i.label){case 0:return t?(a=!1,["-- time --","-- value --"].forEach((function(e){-1!==t.indexOf(e)&&(a=!0)})),a?[2,{rows:null,schema:null}]:[4,this.doQueryRequest(t,e,r)]):[2,{rows:null,schema:null}];case 1:return 0===(n=i.sent()).length?[2,{rows:null,schema:null}]:(o=n.data.jobReference.jobId,[4,this._waitForJobComplete(n,e,o)]);case 2:return 0===(n=i.sent()).length?[2,{rows:null,schema:null}]:(s=n.data.rows,u=n.data.schema,[4,this._getQueryResults(n,s,e,o)]);case 3:return[2,{rows:s=i.sent(),schema:u}]}}))}))},t.prototype.paginatedResults=function(t,e){return n(this,void 0,void 0,(function(){var r,a,n;return i(this,(function(i){switch(i.label){case 0:return[4,this.doRequest(""+this.baseUrl+t)];case 1:if(r=i.sent(),!(a=r.data))return[2,a];(n=e.split(".")).forEach((function(t){a&&a[t]&&(a=a[t])})),i.label=2;case 2:return r&&r.data&&r.data.nextPageToken?[4,this.doRequest(""+this.baseUrl+t+"?pageToken="+r.data.nextPageToken)]:[3,4];case 3:return r=i.sent(),n.forEach((function(t){a=a.concat(r.data[t])})),[3,2];case 4:return[2,a]}}))}))},t.prototype._updateAlias=function(t,e,r){var a,n;if(void 0!==r){var i=r.search("_shifted"),s=r.substr(i,r.length);try{for(var u=o(e.targets[0].select[0]),l=u.next();!l.done;l=u.next()){var c=l.value;if("alias"===c.type)return t=t.replace("AS "+c.params[0],"AS "+c.params[0]+s)}}catch(t){a={error:t}}finally{try{l&&!l.done&&(n=u.return)&&n.call(u)}finally{if(a)throw a.error}}var p=[e.targets[0].select[0][0].params[0]+s],h=this.queryModel.buildValueColumn(e.targets[0].select[0]),m=this.queryModel.buildValueColumn([e.targets[0].select[0][0],e.targets[0].select[0][1],{type:"alias",params:[p]}]);t=t.replace(h,m)}return t},t}(),gt=r(8),vt=r.n(gt),yt=r(9),St=function(t){this.type=t.type,t.label?this.label=t.label:this.label=this.type[0].toUpperCase()+this.type.substring(1)+":",this.style=t.style,"function"===this.style?(this.wrapOpen="(",this.wrapClose=")",this.separator=", "):(this.wrapOpen=" ",this.wrapClose=" ",this.separator=" "),this.params=t.params,this.defaultParams=t.defaultParams},bt=function(){function t(t,e){if(this.part=t,this.def=e,!this.def)throw{message:"Could not find sql part "+t.type};this.datatype=t.datatype,t.name?(this.name=t.name,this.label=e.label+" "+t.name):(this.name="",this.label=e.label),t.params=t.params||l.a.clone(this.def.defaultParams),this.params=t.params}return t.prototype.updateParam=function(t,e){""===t&&this.def.params[e].optional?this.params.splice(e,1):this.params[e]=t,this.part.params=this.params},t}(),wt=[];function Tt(t){wt[t.type]=new St(t)}Tt({defaultParams:["value"],params:[{type:"column",dynamicLookup:!0}],style:"label",type:"column"}),Tt({defaultParams:["value","=","value"],label:"Expr:",params:[{name:"left",type:"string",dynamicLookup:!0},{name:"op",type:"string",dynamicLookup:!0},{name:"right",type:"string",dynamicLookup:!0}],style:"expression",type:"expression"}),Tt({defaultParams:[],label:"Macro:",params:[],style:"label",type:"macro"}),Tt({defaultParams:["1m"],params:[{name:"name",options:["1s","1min","1h","1d","1w","1m","1y"],type:"string"}],style:"label",type:"timeshift"}),Tt({type:"aggregate",style:"label",params:[{name:"name",type:"string",options:["avg","count","min","max","sum","stddev","variance"]}],defaultParams:["avg"]}),Tt({type:"alias",style:"label",params:[{name:"name",type:"string",quote:"double"}],defaultParams:["alias"]}),Tt({type:"time",style:"function",label:"time",params:[{name:"interval",options:["$__interval","1s","1min","1h","1d","1w","1m","1y","auto"],type:"interval"},{name:"mininterval",type:"interval",options:["$__mininterval","1s","1min","1h","1d","1w","1m","1y"]}],defaultParams:["$__interval","0"]}),Tt({type:"window",style:"label",params:[{name:"function",type:"string",options:["delta","increase","rate","sum"]}],defaultParams:["increase"]}),Tt({type:"moving_window",style:"label",label:"Moving Window:",params:[{name:"function",type:"string",options:["avg"]},{name:"window_size",type:"number",options:["3","5","7","10","20"]}],defaultParams:["avg","5"]}),Tt({type:"hll_count.merge",style:"label",label:"Hll_count.merge:",params:[{name:"function",type:"string",options:["precision"]},{name:"precision",type:"number",options:["10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"]}],defaultParams:["precision","15"]}),Tt({type:"hll_count.extract",style:"label",label:"Hll_count.extract:",params:[{name:"function",type:"string",options:["precision"]},{name:"precision",type:"number",options:["10","11","12","13","14","15","16","17","18","19","20","21","22","23","24"]}],defaultParams:["precision","15"]});var xt={create:function(t){var e=wt[t.type];return e?new bt(t,e):null}},_t=function(t){function e(e,r,a,n,i){var o=t.call(this,e,r)||this;return o.templateSrv=a,o.$q=n,o.uiSegmentSrv=i,o.queryModel=new h(o.target,a,o.panel.scopedVars),o.updateProjection(),o.formats=[{text:"Time series",value:"time_series"},{text:"Table",value:"table"}],o.orderByCols=[{text:"Time",value:"1"},{text:"Metric",value:"2"}],o.orderBySorts=[{text:"ASC",value:"1"},{text:"DESC",value:"2"}],o.locations=[{text:"United States (US)",value:"US"},{text:"European Union (EU)",value:"EU"},{text:"Oregon (us-west1)",value:"us-west1"},{text:"Los Angeles (us-west2)",value:"us-west2"},{text:"Salt Lake City (us-west3)",value:"us-west3"},{text:"Las Vegas (us-west4)",value:"us-west4"},{text:"Iowa (us-central1)",value:"us-central1"},{text:"South Carolina (us-east1)",value:"us-east1"},{text:"Northern Virginia (us-east4)",value:"us-east4"},{text:"Montréal (northamerica-northeast1)",value:"northamerica-northeast1"},{text:"São Paulo (southamerica-east1)",value:"southamerica-east1"},{text:"Belgium (europe-west1)",value:"europe-west1"},{text:"Finland (europe-north1)",value:"europe-north1"},{text:"Frankfurt (europe-west3)",value:"europe-west3"},{text:"London (europe-west2)",value:"europe-west2"},{text:"Netherlands (europe-west4)",value:"europe-west4"},{text:"Zürich (europe-west6)",value:"europe-west6"},{text:"Hong Kong (asia-east2)",value:"asia-east2"},{text:"Jakarta (asia-southeast2)",value:"asia-southeast2"},{text:"Mumbai (asia-south1)",value:"asia-south1"},{text:"Osaka (asia-northeast2)",value:"asia-northeast2"},{text:"Seoul (asia-northeast3)",value:"asia-northeast3"},{text:"Singapore (asia-southeast1)",value:"asia-southeast1"},{text:"Sydney (australia-southeast1)",value:"australia-southeast1"},{text:"Taiwan (asia-east1)",value:"asia-east1"},{text:"Tokyo (asia-northeast1)",value:"asia-northeast1"}],o.target.rawSql||("table"===o.panelCtrl.panel.type?(o.target.format="table",o.target.rawSql="SELECT 1",o.target.rawQuery=!0):o.target.rawSql="SELECT\n  time_column,\n  value1\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n"),o.projectSegment=o.target.project?i.newSegment(o.target.project):i.newSegment({fake:!0,value:"select project"}),o.datasetSegment=o.target.dataset?i.newSegment(o.target.dataset):i.newSegment({fake:!0,value:"select dataset"}),o.tableSegment=o.target.table?i.newSegment(o.target.table):i.newSegment({fake:!0,value:"select table"}),o.timeColumnSegment=i.newSegment(o.target.timeColumn),o.metricColumnSegment=i.newSegment(o.target.metricColumn),o.buildSelectMenu(),o.whereAdd=o.uiSegmentSrv.newPlusButton(),o.groupAdd=o.uiSegmentSrv.newPlusButton(),o.panelCtrl.events.on("data-received",o.onDataReceived.bind(o),e),o.panelCtrl.events.on("data-error",o.onDataError.bind(o),e),o}return e.$inject=["$scope","$injector","templateSrv","$q","uiSegmentSrv"],function(t,e){function r(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}(e,t),e.prototype.updateProjection=function(){this.selectParts=l.a.map(this.target.select,(function(t){return l.a.map(t,xt.create).filter((function(t){return t}))})),this.whereParts=l.a.map(this.target.where,xt.create).filter((function(t){return t})),this.groupParts=l.a.map(this.target.group,xt.create).filter((function(t){return t}))},e.prototype.updatePersistedParts=function(){this.target.select=l.a.map(this.selectParts,(function(t){return l.a.map(t,(function(t){return{datatype:t.datatype,params:t.params,type:t.def.type}}))})),this.target.where=l.a.map(this.whereParts,(function(t){return{datatype:t.datatype,name:t.name,params:t.params,type:t.def.type}})),this.target.group=l.a.map(this.groupParts,(function(t){return{datatype:t.datatype,params:t.params,type:t.def.type}}))},e.prototype.buildSelectMenu=function(){this.selectMenu=[];this.selectMenu.push({submenu:[{text:"Average",value:"avg"},{text:"Count",value:"count"},{text:"Maximum",value:"max"},{text:"Minimum",value:"min"},{text:"Sum",value:"sum"},{text:"Standard deviation",value:"stddev"},{text:"Variance",value:"variance"}],text:"Aggregate Functions",value:"aggregate"});this.selectMenu.push({text:"Window Functions",value:"window",submenu:[{text:"Delta",value:"delta"},{text:"Increase",value:"increase"},{text:"Rate",value:"rate"},{text:"Sum",value:"sum"},{text:"Moving Average",value:"avg",type:"moving_window"}]});this.selectMenu.push({text:"HyperLogLog++ Functions",value:"hyperloglog",submenu:[{text:"Hll_count.merge",type:"hll_count.merge",value:"precision"},{text:"Hll_count.extract",type:"hll_count.extract",value:"precision"}]}),this.selectMenu.push({text:"Alias",value:"alias"}),this.selectMenu.push({text:"Column",value:"column"}),this.selectMenu.push({text:"Time Shift",value:"timeshift"})},e.prototype.toggleEditorMode=function(){var t=this;this.target.rawQuery?vt.a.emit("confirm-modal",{icon:"fa-exclamation",onConfirm:function(){t.target.rawQuery=!t.target.rawQuery},text2:"Switching to query builder may overwrite your raw SQL.",title:"Warning",yesText:"Switch"}):this.target.rawQuery=!this.target.rawQuery},e.prototype.resetPlusButton=function(t){var e=this.uiSegmentSrv.newPlusButton();t.html=e.html,t.value=e.value},e.prototype.getProjectSegments=function(){return this.datasource.getProjects().then(this.uiSegmentSrv.transformToSegments(!1)).catch(this.handleQueryError.bind(this))},e.prototype.projectChanged=function(){this.target.project=this.projectSegment.value,this.datasource.projectName=this.projectSegment.value,this.target.dataset="",this.applySegment(this.datasetSegment,this.fakeSegment("select dataset")),this.applySegment(this.tableSegment,this.fakeSegment("select table")),this.applySegment(this.timeColumnSegment,this.fakeSegment("-- time --"))},e.prototype.getDatasetSegments=function(){return this.datasource.getDatasets(this.target.project).then(this.uiSegmentSrv.transformToSegments(!1)).catch(this.handleQueryError.bind(this))},e.prototype.datasetChanged=function(){this.target.dataset=this.datasetSegment.value,this.target.sharded=!1,this.target.partitioned=!1,this.target.partitionedField="",this.applySegment(this.tableSegment,this.fakeSegment("select table")),this.applySegment(this.timeColumnSegment,this.fakeSegment("-- time --"))},e.prototype.getTableSegments=function(){return this.tablesDataPromise=this.datasource.getTables(this.target.project,this.target.dataset),this.tablesDataPromise.then(this.uiSegmentSrv.transformToSegments(!1)).catch(this.handleQueryError.bind(this))},e.prototype.tableChanged=function(){var t=this;this.target.sharded=!1,this.target.partitioned=!1,this.target.partitionedField="",this.target.table=this.tableSegment.value,this.tablesDataPromise.then((function(e){e.forEach((function(e){if(e.text===t.target.table){var r=e.value.indexOf("__partitioned");r>-1&&(t.target.partitioned=!0,t.target.partitionedField=e.value.substr(r+"__partitioned".length+2))}}))})),this.applySegment(this.timeColumnSegment,this.fakeSegment("-- time --"));var e=this.target.table.indexOf("_YYYYMMDD");e>-1&&(this.target.table=this.target.table.substring(0,e+1)+"*",this.target.sharded=!0),this.target.where=[],this.target.group=[],this.target.select=[[{type:"column",params:["-- value --"]}]],this.updateProjection();var r=this.uiSegmentSrv.newSegment("none");this.metricColumnSegment.html=r.html,this.metricColumnSegment.value=r.value,this.target.metricColumn="none";var a=this.getTimeColumnSegments().then((function(e){return e.length>0&&!l.a.find(e,(function(e){return e.text===t.target.timeColumn}))&&(t.timeColumnSegment.html=t.uiSegmentSrv.newSegment(e[0].text).html,t.timeColumnSegment.value=t.uiSegmentSrv.newSegment(e[0].text).value),t.timeColumnChanged(!1)})),n=this.getValueColumnSegments().then((function(e){e.length>0&&(t.target.select=[[{type:"column",params:[e[0].text]}]],t.updateProjection())}));this.$q.all([a,n]).then((function(){t.panelCtrl.refresh()}))},e.prototype.getTimeColumnSegments=function(){return this._getColumnSegments(["DATE","TIMESTAMP","DATETIME"])},e.prototype.getValueColumnSegments=function(){return this._getColumnSegments(["INT64","NUMERIC","FLOAT64","FLOAT","INT","INTEGER"])},e.prototype.timeColumnChanged=function(t){return n(this,void 0,void 0,(function(){var e,r;return i(this,(function(a){switch(a.label){case 0:return this.target.timeColumn=this.timeColumnSegment.value,e=this.target,[4,this._getDateFieldType()];case 1:return e.timeColumnType=a.sent(),r=xt.create({name:"$__timeFilter",params:[],type:"macro"}),this.setwWereParts(r),this.updatePersistedParts(),!1!==t&&this.panelCtrl.refresh(),[2]}}))}))},e.prototype.getMetricColumnSegments=function(){return this.datasource.getTableFields(this.target.project,this.target.dataset,this.target.table,["STRING","BYTES"]).then(this.uiSegmentSrv.transformToSegments(!1)).catch(this.handleQueryError.bind(this))},e.prototype.metricColumnChanged=function(){this.target.metricColumn=this.metricColumnSegment.value,this.panelCtrl.refresh()},e.prototype.onDataReceived=function(t){},e.prototype.onDataError=function(t){if(t.data&&t.data.results){var e=t.data.results[this.target.refId];e&&(this.lastQueryMeta=e.meta,this.lastQueryError=e.error)}},e.prototype.transformToSegments=function(t){var e=this;return function(r){var a,n,i=l.a.map(r,(function(t){return e.uiSegmentSrv.newSegment({value:t.text,expandable:t.expandable})}));if(t.addTemplateVars)try{for(var s=o(e.templateSrv.variables),u=s.next();!u.done;u=s.next()){var c=u.value,p=void 0;p="$"+c.name,t.templateQuoter&&!1===c.multi&&(p=t.templateQuoter(p)),i.unshift(e.uiSegmentSrv.newSegment({expandable:!0,type:"template",value:p}))}}catch(t){a={error:t}}finally{try{u&&!u.done&&(n=s.return)&&n.call(s)}finally{if(a)throw a.error}}return t.addNone&&i.unshift(e.uiSegmentSrv.newSegment({type:"template",value:"none",expandable:!0})),i}},e.prototype.findAggregateIndex=function(t){return l.a.findIndex(t,(function(t){return"aggregate"===t.def.type||"percentile"===t.def.type}))},e.prototype.findWindowIndex=function(t){return l.a.findIndex(t,(function(t){return"window"===t.def.type||"moving_window"===t.def.type}))},e.prototype.findHllIndex=function(t){return l.a.findIndex(t,(function(t){return"hyperloglog"===t.def.type||"hll_count.init"===t.def.type}))},e.prototype.findTimeShiftIndex=function(t){return l.a.findIndex(t,(function(t){return"timeshift"===t.def.type}))},e.prototype.applySegment=function(t,e){t.value=e.value,t.html=e.html||e.value,t.fake=void 0!==e.fake&&e.fake},e.prototype.fakeSegment=function(t){return this.uiSegmentSrv.newSegment({fake:!0,value:t})},e.prototype.addSelectPart=function(t,e,r){var a=e.value;r&&r.type&&(a=r.type);var n=xt.create({type:a});r&&(n.params[0]=r.value);var i=!1,o=function(){return!l.a.find(t,(function(t){return"alias"===t.def.type}))};switch(a){case"column":var s=l.a.map(t,(function(t){return xt.create({type:t.def.type,params:l.a.clone(t.params)})}));this.selectParts.push(s);break;case"percentile":case"aggregate":0===this.target.group.length&&this.addGroup("time","$__interval");var u=this.findAggregateIndex(t);-1!==u?t[u]=n:t.splice(1,0,n),o()&&(i=!0);break;case"moving_window":case"window":var c=this.findWindowIndex(t);if(-1!==c)t[c]=n;else{var p=this.findAggregateIndex(t);-1!==p?t.splice(p+1,0,n):t.splice(1,0,n)}case"hll_count.merge":case"hll_count.extract":if(-1!==this.findHllIndex(t))t[c]=n;else{var h=this.findAggregateIndex(t);-1!==h?t.splice(h+1,0,n):t.splice(1,0,n)}o()&&(i=!0);break;case"alias":i=!0;break;case"timeshift":var m=this.findTimeShiftIndex(t);-1!==m?t[m]=n:t.push(n)}i&&(n=xt.create({type:"alias",params:[t[0].params[0].replace(/"/g,"")]}),"alias"===t[t.length-1].def.type?t[t.length-1]=n:t.push(n)),this.updatePersistedParts(),this.panelCtrl.refresh()},e.prototype.removeSelectPart=function(t,e){if("column"===e.def.type){if(this.selectParts.length>1){var r=l.a.indexOf(this.selectParts,t);this.selectParts.splice(r,1)}}else{var a=l.a.indexOf(t,e);t.splice(a,1)}this.updatePersistedParts()},e.prototype.handleSelectPartEvent=function(t,e,r){switch(r.name){case"get-param-options":switch(e.def.type){case"aggregate":return;case"column":return this.getValueColumnSegments()}case"part-param-changed":this.updatePersistedParts(),this.panelCtrl.refresh();break;case"action":this.removeSelectPart(t,e),this.panelCtrl.refresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},e.prototype.handleGroupPartEvent=function(t,e,r){switch(r.name){case"get-param-options":return this._getAllFields();case"part-param-changed":this.updatePersistedParts(),this.panelCtrl.refresh();break;case"action":this.removeGroup(t,e),this.panelCtrl.refresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},e.prototype.addGroup=function(t,e){var r,a;this._setGroupParts(t,e);try{for(var n=o(this.selectParts),i=n.next();!i.done;i=n.next()){var s=i.value;if(!s.some((function(t){return"aggregate"===t.def.type}))){var u=xt.create({params:["avg"],type:"aggregate"});if(s.splice(1,0,u),!s.some((function(t){return"alias"===t.def.type}))){var l=xt.create({params:[s[0].part.params[0]],type:"alias"});s.push(l)}}}}catch(t){r={error:t}}finally{try{i&&!i.done&&(a=n.return)&&a.call(n)}finally{if(r)throw r.error}}this.updatePersistedParts()},e.prototype.removeGroup=function(t,e){"time"===t.def.type&&(this.selectParts=l.a.map(this.selectParts,(function(t){return l.a.filter(t,(function(t){return!("aggregate"===t.def.type||"percentile"===t.def.type)}))}))),this.groupParts.splice(e,1),this.updatePersistedParts()},e.prototype._getAllFields=function(){return this.datasource.getTableFields(this.target.project,this.target.dataset,this.target.table,[]).then(this.transformToSegments({})).catch(this.handleQueryError.bind(this))},e.prototype.handleWherePartEvent=function(t,e,r,a){switch(r.name){case"get-param-options":switch(r.param.name){case"left":return this._getAllFields();case"right":return this.$q.when([]);case"op":return this.$q.when(this.uiSegmentSrv.newOperators(["=","!=","<","<=",">",">=","IN","LIKE","NOT LIKE","IS","IS NOT"]));default:return this.$q.when([])}case"part-param-changed":this.updatePersistedParts(),this.panelCtrl.refresh();break;case"action":t.splice(a,1),this.updatePersistedParts(),this.panelCtrl.refresh();break;case"get-part-actions":return this.$q.when([{text:"Remove",value:"remove-part"}])}},e.prototype.getWhereOptions=function(){var t=[];return t.push(this.uiSegmentSrv.newSegment({type:"macro",value:"$__timeFilter"})),t.push(this.uiSegmentSrv.newSegment({type:"macro",value:"$__timeFrom"})),t.push(this.uiSegmentSrv.newSegment({type:"macro",value:"$__timeTo"})),t.push(this.uiSegmentSrv.newSegment({type:"expression",value:"Expression"})),this.$q.when(t)},e.prototype.setwWereParts=function(t){this.whereParts.length>=1&&"macro"===this.whereParts[0].def.type?this.whereParts[0]=t:this.whereParts.splice(0,0,t)},e.prototype.addWhereAction=function(t,e){switch(this.whereAdd.type){case"macro":var r=xt.create({name:this.whereAdd.value,params:[],type:"macro"});this.setwWereParts(r);break;default:this.whereParts.push(xt.create({params:["value","=","value"],type:"expression"}))}this.updatePersistedParts(),this.resetPlusButton(this.whereAdd),this.panelCtrl.refresh()},e.prototype.getGroupOptions=function(){var t=this;return this.getMetricColumnSegments().then((function(e){var r,a,n=[];t.queryModel.hasTimeGroup()||n.push(t.uiSegmentSrv.newSegment({type:"time",value:"time($__interval,0)"}));try{for(var i=o(e),s=i.next();!s.done;s=i.next()){var u=s.value;n.push(t.uiSegmentSrv.newSegment({type:"column",value:u.text}))}}catch(t){r={error:t}}finally{try{s&&!s.done&&(a=i.return)&&a.call(i)}finally{if(r)throw r.error}}return n})).catch(this.handleQueryError.bind(this))},e.prototype.addGroupAction=function(){this.groupAdd.value,this.addGroup(this.groupAdd.type,this.groupAdd.value),this.resetPlusButton(this.groupAdd),this.panelCtrl.refresh()},e.prototype.handleQueryError=function(t){return this.error=t.message||"Failed to issue metric query",[]},e.prototype._setGroupParts=function(t,e){var r=[e];"time"===t&&(r=["$__interval","none"]);var a=xt.create({type:t,params:r});"time"===t?this.groupParts.splice(0,0,a):this.groupParts.push(a)},e.prototype._getColumnSegments=function(t){return this.datasource.getTableFields(this.target.project,this.target.dataset,this.target.table,t).then(this.uiSegmentSrv.transformToSegments(!1)).catch(this.handleQueryError.bind(this))},e.prototype._getDateFieldType=function(){return n(this,void 0,void 0,(function(){var t,e=this;return i(this,(function(r){switch(r.label){case 0:return t="",[4,this.datasource.getTableFields(this.target.project,this.target.dataset,this.target.table,["DATE","TIMESTAMP","DATETIME"]).then((function(r){var a,n;try{for(var i=o(r),s=i.next();!s.done;s=i.next()){var u=s.value;u.text===e.target.timeColumn&&(t=u.value)}}catch(t){a={error:t}}finally{try{s&&!s.done&&(n=i.return)&&n.call(i)}finally{if(a)throw a.error}}}))];case 1:return r.sent(),[2,t]}}))}))},e.templateUrl="partials/query.editor.html",e}(yt.QueryCtrl),Pt=function(){function t(t){this.validationErrors=[],this.defaultAuthenticationType="jwt",this.defaultFlatRateProject=void 0,this.defaultProcessingLocation=void 0,this.datasourceSrv=t,this.current.jsonData=this.current.jsonData||{},this.current.jsonData.authenticationType=this.current.jsonData.authenticationType?this.current.jsonData.authenticationType:this.defaultAuthenticationType,void 0===this.current.jsonData.flatRateProject&&(this.current.jsonData.flatRateProject=this.defaultFlatRateProject),void 0===this.current.jsonData.processingLocations&&(this.current.jsonData.processingLocations=this.defaultProcessingLocation),this.current.jsonData.queryPriority&&this.current.jsonData.queryPriority.match(/\b^INTERACTIVE$\b|\b^BATCH$\b/i)||(this.current.jsonData.queryPriority="INTERACTIVE"),this.current.secureJsonData=this.current.secureJsonData||{},this.current.secureJsonFields=this.current.secureJsonFields||{},this.authenticationTypes=[{key:this.defaultAuthenticationType,value:"Google JWT File"},{key:"gce",value:"GCE Default Service Account"}],this.locations=[{text:"United States (US)",value:"US"},{text:"European Union (EU)",value:"EU"},{text:"Oregon (us-west1)",value:"us-west1"},{text:"Los Angeles (us-west2)",value:"us-west2"},{text:"Salt Lake City (us-west3)",value:"us-west3"},{text:"Las Vegas (us-west4)",value:"us-west4"},{text:"Iowa (us-central1)",value:"us-central1"},{text:"South Carolina (us-east1)",value:"us-east1"},{text:"Northern Virginia (us-east4)",value:"us-east4"},{text:"Montréal (northamerica-northeast1)",value:"northamerica-northeast1"},{text:"São Paulo (southamerica-east1)",value:"southamerica-east1"},{text:"Belgium (europe-west1)",value:"europe-west1"},{text:"Finland (europe-north1)",value:"europe-north1"},{text:"Frankfurt (europe-west3)",value:"europe-west3"},{text:"London (europe-west2)",value:"europe-west2"},{text:"Netherlands (europe-west4)",value:"europe-west4"},{text:"Zürich (europe-west6)",value:"europe-west6"},{text:"Hong Kong (asia-east2)",value:"asia-east2"},{text:"Jakarta (asia-southeast2)",value:"asia-southeast2"},{text:"Mumbai (asia-south1)",value:"asia-south1"},{text:"Osaka (asia-northeast2)",value:"asia-northeast2"},{text:"Seoul (asia-northeast3)",value:"asia-northeast3"},{text:"Singapore (asia-southeast1)",value:"asia-southeast1"},{text:"Sydney (australia-southeast1)",value:"australia-southeast1"},{text:"Taiwan (asia-east1)",value:"asia-east1"},{text:"Tokyo (asia-northeast1)",value:"asia-northeast1"}],this.queryPriority=[{text:"INTERACTIVE",value:"INTERACTIVE"},{text:"BATCH",value:"BATCH"}]}return t.$inject=["datasourceSrv"],t.prototype.onUpload=function(t){this.jsonText="",this.validateJwt(t)&&this.save(t)},t.prototype.onPasteJwt=function(t){try{var e=JSON.parse(t.originalEvent.clipboardData.getData("text/plain")||this.jsonText);this.validateJwt(e)&&this.save(e)}catch(t){this.resetValidationMessages(),this.validationErrors.push("Invalid json: "+t.message)}},t.prototype.resetValidationMessages=function(){this.validationErrors=[],this.inputDataValid=!1,this.jsonText="",this.current.jsonData={authenticationType:this.current.jsonData.authenticationType},this.current.secureJsonData={},this.current.secureJsonFields={}},t.prototype.save=function(t){this.current.secureJsonData.privateKey=t.private_key,this.current.jsonData.tokenUri=t.token_uri,this.current.jsonData.clientEmail=t.client_email,this.current.jsonData.defaultProject=t.project_id},t.prototype.validateJwt=function(t){return this.resetValidationMessages(),t.private_key&&0!==t.private_key.length||this.validationErrors.push("Private key field missing in JWT file."),t.token_uri&&0!==t.token_uri.length||this.validationErrors.push("Token URI field missing in JWT file."),t.client_email&&0!==t.client_email.length||this.validationErrors.push("Client Email field missing in JWT file."),t.project_id&&0!==t.project_id.length||this.validationErrors.push("Project Id field missing in JWT file."),0===this.validationErrors.length&&(this.inputDataValid=!0,!0)},t.templateUrl="partials/config.html",t}();r.d(e,"AnnotationsQueryCtrl",(function(){return Ct})),r.d(e,"BigQueryDatasource",(function(){return dt})),r.d(e,"Datasource",(function(){return dt})),r.d(e,"QueryCtrl",(function(){return _t})),r.d(e,"ConfigCtrl",(function(){return Pt}));var Ct=function(){function t(){this.annotation.rawQuery=this.annotation.rawQuery||"SELECT\n  extract(epoch from time_column) AS time,\n  text_column as text,\n  tags_column as tags\nFROM\n  metric_table\nWHERE\n  $__timeFilter(time_column)\n"}return t.templateUrl="partials/annotations.editor.html",t}()}])}));
//# sourceMappingURL=module.js.map